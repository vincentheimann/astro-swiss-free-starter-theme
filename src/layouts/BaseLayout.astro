---
import type { ImageMetadata } from "astro";
import "@/styles/global.css";
import FallbackImage from "../assets/images/fallback-image.png";
import { defaultLang, languages, type Language } from "../i18n/ui";
import { useTranslations } from "../i18n/utils";

interface Props {
    title?: string;
    description?: string;
    image?: ImageMetadata;
}

const siteOrigin = Astro.site ?? new URL(Astro.url).origin;

const { title, description, image = FallbackImage } = Astro.props;
const imageUrl = new URL(image.src, siteOrigin).toString();

// Get current language - dynamically support any language defined in languages object
const currentLocale = Astro.currentLocale;
const lang: Language =
    currentLocale && currentLocale in languages
        ? (currentLocale as Language)
        : defaultLang;

const t = useTranslations(lang);

// Use translated defaults or provided overrides
const pageTitle = title || t("site.title");
const pageDescription = description || t("site.description");

// Locale mapping for Open Graph (language_TERRITORY format)
const localeMap: Record<Language, string> = {
    fr: "fr_FR",
    de: "de_DE",
};
const ogLocale = localeMap[lang] || "fr_FR";

// Build canonical URL
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Build alternate language URLs for hreflang
const alternateLanguages = Object.keys(languages) as Language[];
---

<!doctype html>
<html lang={lang}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content={Astro.generator} />

        <!-- Primary Meta Tags -->
        <title>{pageTitle}</title>
        <meta name="title" content={pageTitle} />
        <meta name="description" content={pageDescription} />
        <meta name="author" content={t("author.name")} />

        <!-- Color Scheme and Theme -->
        <meta name="color-scheme" content="light dark" />
        <meta
            name="theme-color"
            content="#ffffff"
            media="(prefers-color-scheme: light)"
        />
        <meta
            name="theme-color"
            content="#0f172a"
            media="(prefers-color-scheme: dark)"
        />

        <!-- Canonical URL -->
        <link rel="canonical" href={canonicalURL} />

        <!-- Alternate Language Links (hreflang) -->
        {
            alternateLanguages.map((locale) => {
                const href =
                    locale === defaultLang
                        ? new URL("/", Astro.site)
                        : new URL(`/${locale}/`, Astro.site);
                return <link rel="alternate" hreflang={locale} href={href} />;
            })
        }
        <link
            rel="alternate"
            hreflang="x-default"
            href={new URL("/", Astro.site)}
        />

        <!-- Open Graph / Social Media -->
        <meta property="og:type" content="website" />
        <meta property="og:site_name" content={t("business.name")} />
        <meta property="og:locale" content={ogLocale} />
        {
            alternateLanguages
                .filter((locale) => locale !== lang)
                .map((locale) => (
                    <meta
                        property="og:locale:alternate"
                        content={localeMap[locale]}
                    />
                ))
        }
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:title" content={pageTitle} />
        <meta property="og:description" content={pageDescription} />
        <meta property="og:image" content={imageUrl} />
        <meta property="og:image:alt" content={pageTitle} />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="og:image:type" content="image/png" />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={pageTitle} />
        <meta name="twitter:description" content={pageDescription} />
        <meta name="twitter:image" content={imageUrl} />
        <meta name="twitter:image:alt" content={pageTitle} />

        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

        <!-- Font preloads -->
        <link
            rel="preload"
            href="/fonts/Poppins-Regular.ttf"
            as="font"
            type="font/ttf"
            crossorigin
        />
        <link
            rel="preload"
            href="/fonts/Poppins-Bold.ttf"
            as="font"
            type="font/ttf"
            crossorigin
        />

        <!-- Robots -->
        <meta name="robots" content="index,follow,max-image-preview:large" />

        <!-- JSON-LD Structured Data for GEO -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@graph": [
                    {
                        "@type": "WebSite",
                        "@id": `${siteOrigin}/#website`,
                        url: siteOrigin,
                        name: t("business.name"),
                        description: t("business.description"),
                        inLanguage: lang,
                    },
                    {
                        "@type": "Organization",
                        "@id": `${siteOrigin}/#organization`,
                        name: t("business.name"),
                        url: siteOrigin,
                        logo: {
                            "@type": "ImageObject",
                            url: `${siteOrigin}/logo.svg`,
                        },
                        contactPoint: {
                            "@type": "ContactPoint",
                            telephone: t("author.phone"),
                            email: t("author.email"),
                            contactType: "customer service",
                            availableLanguage: alternateLanguages,
                        },
                    },
                ],
            })}
        />

        <!-- Theme initialization (prevents FOUC) -->
        <script is:inline>
            const isDark =
                localStorage.theme === "dark" ||
                (!("theme" in localStorage) &&
                    window.matchMedia("(prefers-color-scheme: dark)").matches);
            // Set both class and data-theme attribute for maximum compatibility
            document.documentElement.classList.toggle("dark", isDark);
            if (isDark) {
                document.documentElement.setAttribute("data-theme", "dark");
            } else {
                document.documentElement.setAttribute("data-theme", "light");
            }
        </script>
    </head>

    <body>
        <slot />
    </body>
</html>
